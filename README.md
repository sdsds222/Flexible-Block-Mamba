# Flexible Block Mamba


**简介**
Flexible Blocks Mamba 在不改动 Mamba 高度并行的主干的前提下，实现“先按最小块划分 → 并行卷积打分 → 只在同父内合并属性相同的相邻块 → 生成指导地图”。这样既保留一次块级扫描与高并行 O(N)，又把算力按需投向关键片段，并可对局部片段执行反向（REV）以增强建模能力。

---

## 步骤一：按最小块 L0 切分

* 将输入序列按超参 **L0**（如 64）等距切成最小块 `B0[i]`。
* 仅在这些不重叠的最小块上做后续判定，保证并行与对齐。

## 步骤二：卷积并行打分与属性标注（逐 L0 块）

* 用少量多尺度/空洞 **Conv1D** 一次性提取整序列特征。
* 对每个最小块做池化聚合（如 mean/max/std）+ 轻量 MLP，比对输出的评分结果属性（如相似度，一致性，方向等）


## 步骤三：同父合并（严格二叉对齐）

* 仅在**同一父节点**内尝试合并相邻最小块：

  * 先检查 `(B0[2j], B0[2j+1])` 比对参数情况是否一致或相似**；比对通过后则合成 2·L0 块 `B1[j]`；
  * 再在更高层检查 `(B1[2k], B1[2k+1])` 是否一致，若一致则合成 4·L0，以此类推，直到无法继续。

## 步骤四：相邻同性质区域再合并（可选）

* 若最终输出里出现多个**同层、同属性**的相邻块，可继续在二叉约束下向上合并（不跨父），形成更大的 2^k·L0 区域，进一步减少块数。

## 步骤五：局部反向

* **前置反转**：对标注为 **REV** 的最终块，直接在输入上**反转该子序列**，再送入 Mamba；主干无需改动。

## 步骤六：生成指导地图

  1. 指导分块与分桶执行
  2. 或在送入 Mamba 前进行局部前置反转。

## 步骤七：按地图执行 Mamba

* 按类型分桶，仅对这些块运行 Mamba 的块内核（块内并行）。
* 对块摘要序列做一次块级前缀扫描得到真实起始状态；

---

## 设想拓展

* **节点级算子门控**：在“同父合并”时，对**子摘要与恒等**做线性混合（门控），再合成父摘要，保证**仿射可折叠+结合律**，可把反向/双向/计算强度更精准投到关键节点。在每次算子的上行合并（两个子块 → 父块）前，依据地图对参与合并的子算子施加线性门控（“双向标注→放大反向门控”“单向标注→减弱反向门控”），再执行父算子合成； 门控设计为对子摘要与恒等的线性混合，不改接口维度、仍属仿射类，从而保持可结合→可用并行前缀/树形扫描。
* **ConvMap 全量地图**：让卷积头一次性输出“块长类别/分支门控/节点门控”三图，直接驱动“分块+分桶+门控合并”的流水。

---



# Smart-Zipper-Mamba

通过次方法，可融合双向mamba扫描出的Yf和Yb，为每个点位生成优质的Y结果。

步骤一：全局双向扫描 (O(N) 并行)

动作：首先，我们并行运行两个全局的 Mamba 扫描器（一个正向，一个反向）。

输出：我们得到两个完整的、未经修改的“单向建议”序列：

Y_f (从 t=1 到 N 的正向输出序列)

Y_b (从 t=N 到 1 的反向输出序列)

步骤二：拓宽视野

动作：我们将 Y_f 和 Y_b 沿着“通道”维度拼接 (Concat) 起来，得到一个“双通道”的序列 Y_in。

关键创新：我们不直接使用 Y_in。相反，我们用一个一维卷积 (Conv1D)（比如 kernel_size=3 或 5）来处理 Y_in。

输出：我们得到一个新的“摘要”序列，Y_local_context。

作用：在 t 时刻的 Y_local_context[t]，不再是“近视”的，它已经是一个融合了 t 时刻及其邻居（如 t-1, t+1）信息的**“宽视野摘要”**。

步骤三：计算智能门控 (基于“宽视野”)

动作：我们把这个“宽视野摘要” (Y_local_context) 喂给两个独立的门控网络 (MLP)。

输出：两个“维度级”的门控向量 g_f 和 g_b。

g_f = Sigmoid(MLP_f(Y_local_context))

g_b = Sigmoid(MLP_g(Y_local_context))

作用：g_f 和 g_b 是“拉链头”做出的智能决策，它基于一个短语（而不是一个词）来决定融合比例。

步骤四：维度级融合

动作：我们使用上一步计算出的智能门控 g_f 和 g_b，来对步骤一中的原始 Y_f 和 Y_b 进行逐元素的加权融合。

最终输出 (Y_t)： Y_t = (g_f[t] * Y_f[t]) + (g_b[t] * Y_b[t]) (这里的 * 是逐元素乘法)

拓展：
动态自适应卷积核：先得到双向输出：Y_f, Y_b（两遍 Mamba）。用一个感受野控制器 RFC，根据xt, Y_f, Y_b进行预测卷积核的尺寸和配置。

